## ä»€ä¹ˆæ˜¯ç«æ€é—®é¢˜ï¼Ÿ

ç«æ€é—®é¢˜ï¼ˆRace conditionï¼‰æ˜¯æŒ‡åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹ä»¥ä¸å¯é¢„çŸ¥çš„æ–¹å¼ç›¸äº’å¹²æ‰°æˆ–ç«äº‰èµ„æºçš„ç°è±¡ã€‚

åœ¨å¦‚ä»Šå‰åç«¯åˆ†ç¦»çš„å¤§èƒŒæ™¯ä¸‹ï¼Œajaxè¯·æ±‚å‡ ä¹æ˜¯ä¸å¯æˆ–ç¼ºçš„ï¼Œå¤ä¹ ä¸‹å®šä¹‰

Ajaxï¼ˆAsynchronous JavaScript and XMLï¼‰æ˜¯ä¸€ç§ç”¨äºåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´è¿›è¡Œå¼‚æ­¥æ•°æ®äº¤äº’çš„æŠ€æœ¯ã€‚å®ƒå…è®¸é€šè¿‡JavaScriptåœ¨ä¸åˆ·æ–°æ•´ä¸ªé¡µé¢çš„æƒ…å†µä¸‹ï¼Œå‘æœåŠ¡å™¨å‘é€HTTPè¯·æ±‚å¹¶æ¥æ”¶å“åº”ã€‚

ps: Ajaxä¸ä»…é™äºä½¿ç”¨XMLä½œä¸ºæ•°æ®äº¤æ¢æ ¼å¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–æ ¼å¼ï¼Œå¦‚JSONã€‚



å°±æ‹¿bç«™çš„æœç´¢é¡µå°±æ˜¯ç‰¹åˆ«å…¸å‹çš„ä¾‹å­ï¼Œä¸Šæ–¹æ¡ä»¶æ¡†çš„æ”¹å˜å¯¹åº”æ–°çš„è¯·æ±‚æ¡ä»¶ï¼Œè¯·æ±‚æ¡ä»¶æ”¹å˜è§¦å‘è¯·æ±‚è·å–å¯¹åº”çš„æ•°æ®

![image-20230805125747601](./%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E6%97%A5%E5%B8%B8%E4%B9%8B%E7%AB%9E%E6%80%81%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E5%A4%A7%E5%85%A8.assets/image-20230805125747601.png)



é€šå¸¸æˆ‘ä»¬å®ç°ä¸Šé¢è¿™ä¸ªæœç´¢åŠŸèƒ½çš„é€»è¾‘æ˜¯ ï¼š 

è§¦å‘è¯·æ±‚ -->  ç­‰å¾…èµ„æºè¿”å›  --> å¤„ç†è¿”å›çš„èµ„æº --> æ›´æ–°é¡µé¢çŠ¶æ€

æ‹¿ä»£ç æ¥è¯´å°±æ˜¯è¿™æ ·

```javascript
const search = async ()=>{
  		// 1.è¯·æ±‚å¹¶ç­‰å¾…
      const res = await qryList(params)
      // 2.å¤„ç†èµ„æºå¹¶æ›´æ–°é¡µé¢çŠ¶æ€
      // vue é€šè¿‡ä¿®æ”¹å“åº”å¼æ•°æ®å»æ›´æ–°è§†å›¾
      dataList.value = res.slice()
      // rect é€šè¿‡setStateå»æ›´æ–°è§†å›¾
      setDataList(res.slice())
}
```

å› ä¸ºjavascriptçš„å¼‚æ­¥æœºåˆ¶ï¼Œ**å¤„ç†è¿”å›çš„èµ„æº**è¿™ä¸€æ­¥æ˜¯å¼‚æ­¥æ“ä½œï¼Œç”±äºç½‘ç»œçš„ä¸ç¡®å®šæ€§ï¼Œå½“æˆ‘ä»¬è¿ç»­å¿«é€Ÿçš„è§¦å‘åŒä¸€æ®µé€»è¾‘æ—¶ï¼Œå°±ä¼šå‘ç”Ÿç«æ€é—®é¢˜äº†ã€‚

å‡è®¾ä½ åœ¨ä¸Šå›¾bç«™æœç´¢æ è¿™é‡Œå¿«é€Ÿç‚¹äº†ä¸åŒçš„æ¡ä»¶ï¼Œæ­¤æ—¶å°±ä¼šå‘é€ä¸€ç³»åˆ—çš„è¯·æ±‚ï¼Œæˆ‘ä»¬çš„é¢„æœŸæ˜¯ï¼šé¡µé¢çš„çŠ¶æ€è¦å¯¹å¾—ä¸Šæœ€åå‘å‡ºçš„è¯·æ±‚è¿”å›çš„å†…å®¹ã€‚ä½†æ˜¯ç”±äºè¯·æ±‚æ˜¯ä¸ç¡®å®šçš„ï¼Œå¯èƒ½ä¼šå‡ºç°è¾ƒæ—©å‘å‡ºçš„è¯·æ±‚ï¼Œæ¯”è¾ƒæ™šå‘å‡ºçš„è¯·æ±‚å“åº”æ›´æ…¢ï¼Œæ­¤æ—¶çš„é¡µé¢çŠ¶æ€å°±æœ‰å¯èƒ½æ˜¯è¾ƒæ—©è¯·æ±‚å“åº”çš„çŠ¶æ€ã€‚

å¦‚ä¸Šæ‰€è¿°å°±æ˜¯å…¸å‹çš„ç«æ€é—®é¢˜ï¼Œè¯¥é—®é¢˜æ ¸å¿ƒç‚¹å°±æ˜¯è¿ç»­è§¦å‘ä¸ç¡®å®šçš„å¼‚æ­¥æ“ä½œï¼Œåœ¨å‰ç«¯å¸¸è§çš„åœºæ™¯æœ‰ï¼šæœç´¢ğŸ”ï¼Œé€‰é¡¹å¡åˆ‡æ¢ï¼Œåˆ—è¡¨åˆ†é¡µåˆ‡æ¢ç­‰ç­‰

é‚£ä¹ˆå¦‚ä½•è§£å†³å‘¢ï¼Ÿ 

## è§£å†³æ€è·¯åŠæ–¹æ¡ˆ

### å–æ¶ˆè¯·æ±‚

ä¸€ä¸ªè‡ªç„¶çš„æ€è·¯ä¾¿æ˜¯ï¼šå½“æˆ‘è¿ç»­å‘å‡ºç›¸åŒçš„è¯·æ±‚æ—¶ï¼Œå–æ¶ˆå½“å‰è¿˜æœªå“åº”çš„è¯·æ±‚ã€‚

æ°å·§XMLHttpRequest (XHR) å’ŒFetch API éƒ½æä¾›äº†å–æ¶ˆè¯·æ±‚çš„API

#### XHR

1. åˆ›å»ºä¸€ä¸ªXMLHttpRequestå¯¹è±¡ï¼š`const xhr = new XMLHttpRequest();`
2. æ‰“å¼€è¯·æ±‚çš„æ–¹å¼å’ŒURLï¼š`xhr.open(method, url);`
3. å‘é€è¯·æ±‚ï¼š`xhr.send();`
4. è¦å–æ¶ˆè¯·æ±‚ï¼Œè°ƒç”¨xhrçš„abortæ–¹æ³•ï¼š`xhr.abort();`

#### FETCH

1. åˆ›å»ºä¸€ä¸ªAbortControllerå¯¹è±¡ï¼š`const controller = new AbortController();`
2. ä»controllerä¸­è·å–AbortSignalå¯¹è±¡ï¼š`const signal = controller.signal;`
3. åœ¨fetchè¯·æ±‚ä¸­ä¼ å…¥signalä½œä¸ºoptionsçš„ä¸€ä¸ªå±æ€§ï¼š`fetch(url, { signal })`
4. è¦å–æ¶ˆè¯·æ±‚ï¼Œè°ƒç”¨AbortControllerçš„abortæ–¹æ³•ï¼š`controller.abort();`

#### å…·ä½“å®è·µæ–¹æ¡ˆ

##### axios

å¦‚æœä½ ä½¿ç”¨äº†axiosï¼Œé‚£ä¹ˆä½¿ç”¨æ–¹æ³•è·Ÿä¸Šé¢Fetch API å¾ˆåƒï¼Œå®ƒçš„åŸç†æ˜¯é€šè¿‡cancelé‡Œæ‰§è¡Œrejectå°†promiseè½¬ä¸ºfullfilledçŠ¶æ€ä»¥åŠxhr.abortæ¥å–æ¶ˆè¯·æ±‚

1. å¯¼å…¥axioså’ŒCancelTokenï¼š`import axios, { CancelToken } from 'axios';`
2. åˆ›å»ºä¸€ä¸ªCancelToken.sourceå¯¹è±¡ï¼š`const source = CancelToken.source();`
3. åœ¨å‘é€è¯·æ±‚æ—¶ï¼Œä¼ é€’cancelTokenå‚æ•°ï¼š`axios.get(url, { cancelToken: source.token })`
4. è¦å–æ¶ˆè¯·æ±‚ï¼Œè°ƒç”¨sourceå¯¹è±¡çš„cancelæ–¹æ³•ï¼š`source.cancel('è¯·æ±‚å·²è¢«å–æ¶ˆ');`

æ¢æˆä»£ç å³æ˜¯

```javascript
import axios, { CancelToken } from 'axios';

const source = CancelToken.source();

axios.get(url, { cancelToken: source.token })
  .then(response => {
    // è¯·æ±‚æˆåŠŸå¤„ç†
  })
  .catch(error => {
    // è¿™é‡Œåˆ©ç”¨isCancelå¯ä»¥åˆ¤æ–­æ˜¯å¦æ˜¯å–æ¶ˆ
    if (axios.isCancel(error)) {
      console.log('è¯·æ±‚å·²è¢«å–æ¶ˆ', error.message);
    } else {
      // å…¶ä»–é”™è¯¯å¤„ç†
    }
  });

// è¦å–æ¶ˆè¯·æ±‚ï¼Œè°ƒç”¨sourceå¯¹è±¡çš„cancelæ–¹æ³•
source.cancel('è¯·æ±‚å·²è¢«å–æ¶ˆ');

```

å½“ç„¶è¿˜æœ‰new CancelTokené€šè¿‡ä¼ é€’**executor**è·å–cancelçš„ç”¨æ³•ï¼Œå…·ä½“å¯ä»¥å‚è€ƒaxiosçš„ä½¿ç”¨æ–‡æ¡£

##### vueuse

å¯ä»¥ä½¿ç”¨[useFetch](https://vueuse.org/core/useFetch/#aborting-a-request)è¿™ä¸ªhookæ¥å–æ¶ˆè¯·æ±‚ï¼Œé‡Œé¢æä¾›äº†abortå’Œtimeouté€‰é¡¹ï¼Œä¼šè‡ªåŠ¨å¿½ç•¥è¯·æ±‚

![image-20230806114631472](./%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E6%97%A5%E5%B8%B8%E4%B9%8B%E7%AB%9E%E6%80%81%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E5%A4%A7%E5%85%A8.assets/image-20230806114631472.png)

##### React Query

å¯ä»¥ä½¿ç”¨`useQueryClient` hookä¸­çš„`cancelQueries`æ–¹æ³•æ¥å–æ¶ˆä¸€ä¸ªæˆ–å¤šä¸ªè¯·æ±‚

```javascript
import { useQuery, useQueryClient } from 'react-query';

function App() {
  const queryClient = useQueryClient();

  const { data, isLoading, isError } = useQuery({
     queryKey: ['todos'],
     queryFn: async ({ signal }) => {
        const resp = await fetch('/todos', { signal })
        return resp.json()
     },
  });

  const handleCancelClick = () => {
    // å–æ¶ˆkeyä¸º"todos"çš„è¯·æ±‚
    queryClient.cancelQueries({queryKey:['todos']});
  };

  return (
    <div>
      {/* æ¸²æŸ“æ•°æ® */}
      {isLoading ? 'Loading...' : null}
      {isError ? 'Error: ' + isError.message : null}
      {data ? <div>{data}</div> : null}

      {/* æ¸²æŸ“å–æ¶ˆæŒ‰é’® */}
      <button onClick={handleCancelClick}>Cancel</button>
    </div>
  );
}

```

React Query åªæ˜¯ä½œä¸ºå¤–å±‚å°è£…ï¼Œå¯ä»¥é…åˆXMLã€GraphQLã€Fetchã€axiosç­‰å†…å±‚åŸºç¡€å°è£…æ¥ä½¿ç”¨

å…·ä½“è§[react query cancellation](https://tanstack.com/query/latest/docs/react/guides/query-cancellation)

#### swr

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯swrï¼Œä½ å¯ä»¥ä½¿ç”¨`mutate` å’Œ `useSWRMutation` æ¥é¿å… `useSWR` ä¹‹é—´çš„ç«æ€æ¡ä»¶

```javascript
function Profile() {
  // è·å–ç”¨æˆ·
  const { data } = useSWR('/api/user', getUser, { revalidateInterval: 3000 })
  // æ›´æ–°ç”¨æˆ·
  const { trigger } = useSWRMutation('/api/user', updateUser)
 
  return <>
    {data ? data.username : null}
    <button onClick={() => trigger()}>Update User</button>
  </>
}
```

æ­£å¸¸æƒ…å†µä¸‹ `useSWR` hook å¯èƒ½ä¼šå› ä¸ºèšç„¦ï¼Œè½®è¯¢æˆ–è€…å…¶ä»–æ¡ä»¶åœ¨ä»»ä½•æ—¶é—´åˆ·æ–°ï¼Œè¿™ä½¿å¾—å±•ç¤ºçš„ username å°½å¯èƒ½æ˜¯æœ€æ–°çš„ã€‚ç„¶è€Œï¼Œç”±äºæˆ‘ä»¬åœ¨`useSWR` çš„åˆ·æ–°è¿‡ç¨‹ä¸­å‡ ä¹åŒæ—¶å‘ç”Ÿäº†ä¸€ä¸ªæ•°æ®æ›´æ”¹ï¼Œå¯èƒ½ä¼šå‡ºç° `getUser` è¯·æ±‚æ›´æ—©å¼€å§‹ï¼Œä½†æ˜¯èŠ±çš„æ—¶é—´æ¯” `updateUser` æ›´é•¿ï¼Œå¯¼è‡´ç«æ€æƒ…å†µã€‚

å¹¸è¿çš„æ˜¯ `useSWRMutation` å¯ä»¥ä¸ºä½ è‡ªåŠ¨å¤„ç†è¿™ç§æƒ…å†µã€‚åœ¨æ•°æ®æ›´æ”¹åï¼Œå®ƒä¼šå‘Šè¯‰ `useSWR` æ”¾å¼ƒæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚å’Œé‡æ–°éªŒè¯ï¼Œæ‰€ä»¥æ—§çš„æ•°æ®æ°¸è¿œä¸ä¼šè¢«æ˜¾ç¤ºã€‚



### å¿½ç•¥è¿‡æœŸè¯·æ±‚

é¡¾åæ€ä¹‰å°±æ˜¯éœ€è¦è¾¨è®¤å‡ºæ˜¯å½“å‰çš„è¯·æ±‚æ˜¯å¦è¿‡æœŸï¼Œè¿‡æœŸåˆ™å¿½ç•¥ã€‚è¿™æ ·åšç›¸å¯¹äºå–æ¶ˆè¯·æ±‚çš„ç¼ºç‚¹æ˜¯æ²¡æœ‰å‡è½»æœåŠ¡ç«¯çš„å‹åŠ›

#### å…·ä½“å®è·µæ–¹æ¡ˆ

##### IDæ ‡è¯†

å¯ä»¥ä¸ºæ¯ä¸€ä¸ªè¯·æ±‚é…ç½®ä¸€ä¸ªidï¼Œé€šè¿‡åˆ¤æ–­idæ˜¯å¦æ˜¯å½“å‰æœ€æ–°çš„idï¼Œæ¥å†³å®šæ˜¯å¦é‡‡çº³å½“å‰è¯·æ±‚çš„è¿”å›

```javascript
let searchID = 0
const search = async ()=>{
  		// æ›´æ–°å…¨å±€id
  		searchID +=1
  		// æ›´æ–°å±€éƒ¨id
  		const thisFetchID = searchID
      const res = await qryList(params)
      // å¦‚æœå½“å‰è¯·æ±‚idå’Œå…¨å±€æœ€æ–°çš„idåŒ¹é…ä¸ä¸Šï¼Œåˆ™å¿½ç•¥
      if(thisFetchID !== searchID) return 
}
```

å½“ç„¶ä¹Ÿå¯ä»¥è¿›ä¸€æ­¥å°è£…

```javascript

function resolveLast (){
	const current = {
    currentID:0
  }
  const wrappedFn = (fn) =>{
    current.currentID +=1
    const thisFetchId = current.currentID
    fn.apply(this,current,thisFetchId)
	}
   return wrappedFn
}
// æˆ–è€…
function resolveLast() {
  let currentID = 0;
  const getCurrentId = () => currentID;
  const wrappedFn = (fn) => {
    currentID += 1;
    const thisFetchId = currentID;
    fn.call(this, getCurrentId, thisFetchId);
  };
  return wrappedFn;
}

const wrapper = resolveLast()

wrapper(async (current,thisFetchId)=>{
  // ç­‰å¾…è¯·æ±‚
  await fetch()
  // è¿‡æœŸå°±å¿½ç•¥
  if(current.currentID !==thisFetchId) return 
  // å¤„ç†é€»è¾‘
})
```



##### ahooks

åœ¨ahookså½“ä¸­å¯ä»¥åˆ©ç”¨[useRequestçš„cancel](https://ahooks.gitee.io/zh-CN/hooks/use-request/basic#å–æ¶ˆå“åº”)æ–¹æ³•

![image-20230806110059618](./%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E6%97%A5%E5%B8%B8%E4%B9%8B%E7%AB%9E%E6%80%81%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E5%A4%A7%E5%85%A8.assets/image-20230806110059618.png)

```javascript
import { useRequest } from 'ahooks';
const { loading,  cancel } = useRequest(editUsername);
```

##### 



##### vue3

å¦‚æœä½ æ˜¯åœ¨vue3å½“ä¸­é€šè¿‡watchæ¥ç›‘å¬ä»è€Œå‘è¯·æ±‚çš„

```javascript
watch(obj, async (newValue, oldValue, onCleanup) => {
   // å®šä¹‰ä¸€ä¸ªæ ‡å¿—ï¼Œä»£è¡¨å½“å‰å‰¯ä½œç”¨å‡½æ•°æ˜¯å¦è¿‡æœŸï¼Œé»˜è®¤ä¸º falseï¼Œä»£è¡¨æ²¡æœ‰è¿‡æœŸ
   let expired = false
  // è°ƒç”¨ onCleanup() å‡½æ•°æ³¨å†Œä¸€ä¸ªè¿‡æœŸå›è°ƒ
   onCleanup(() => {
  // å½“è¿‡æœŸæ—¶ï¼Œå°† expired è®¾ç½®ä¸º true
   	expired = true
   })

  // å‘é€ç½‘ç»œè¯·æ±‚
   const res = await fetch('/path/to/request')

  // åªæœ‰å½“è¯¥å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œæ²¡æœ‰è¿‡æœŸæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œåç»­æ“ä½œã€‚
  if (!expired) {
 	  finalData.value = res
   }
})
```

æˆ–è€…watchEffectï¼Œå¯ä»¥é…åˆç›¸å…³çš„cancel å®ç°å¯¹è¯·æ±‚çš„å–æ¶ˆæˆ–è€…å¿½ç•¥

```javascript
watchEffect(async (onCleanup) => {
  const { response, cancel } = doAsyncWork(id.value)
  // `cancel` ä¼šåœ¨ `id` æ›´æ”¹æ—¶è°ƒç”¨
  // ä»¥ä¾¿å–æ¶ˆä¹‹å‰
  // æœªå®Œæˆçš„è¯·æ±‚
  onCleanup(cancel)
  data.value = await response
})
```

åœ¨React å½“ä¸­ï¼Œå¯ä»¥åˆ©ç”¨useEffectçš„**æ¸…é™¤æœºåˆ¶**å°è£…æˆhooks

```javascript
useEffect(() => {
 Â let didCancel = false;
 Â setIsLoading(true);
 Â fetch(`https://get.a.article.com/articles/${articleId}`)
 Â  Â .then((response) => {
 Â  Â  Â if (response.ok) {
 Â  Â  Â  Â return response.json();
 Â  Â  Â }
 Â  Â  Â return Promise.reject();
 Â  Â })
 Â  Â .then((fetchedArticle: Article) => {
 Â  Â  Â if (!didCancel) {
 Â  Â  Â  Â setArticle(fetchedArticle);
 Â  Â  Â }
 Â  Â })
 Â  Â .finally(() => {
 Â  Â  Â setIsLoading(false);
 Â  Â });
 
 Â return () => {
 Â  Â didCancel = true;
 Â }
}, [articleId]);
```

##### react 
åœ¨React å½“ä¸­ï¼Œå¯ä»¥åˆ©ç”¨useEffectçš„**æ¸…é™¤æœºåˆ¶**å°è£…æˆhooks

```javascript
useEffect(() => {
 let didCancel = false;
 setIsLoading(true);
 fetch(`https://get.a.article.com/articles/${articleId}`)
   .then((response) => {
     if (response.ok) {
       return response.json();
     }
     return Promise.reject();
   })
   .then((fetchedArticle: Article) => {
     if (!didCancel) {
       setArticle(fetchedArticle);
     }
   })
   .finally(() => {
     setIsLoading(false);
   });

 return () => {
   didCancel = true;
 }
}, [articleId]);
```

## æ€»ç»“

ç«æ€é—®é¢˜æœ¬è´¨ä¸Šæ˜¯å› ä¸ºjsçš„å¼‚æ­¥æœºåˆ¶å åŠ ç½‘ç»œçš„ä¸ç¡®å®šæ€§ï¼Œå¯¼è‡´å¤„ç†å“åº”å¤„ç†çš„æ—¶æœºä¸ç¡®å®šï¼Œè¿™å’Œæˆ‘ä»¬çš„é¢„æœŸï¼šå…ˆå‘å‡ºçš„è¯·æ±‚å…ˆå¤„ç†å“åº”ä¸ç¬¦ã€‚

é€šå¸¸æ¥è¯´è§£å†³æ­¤ç±»é—®é¢˜ï¼Œæ€è·¯æœ‰2ç§åˆ†åˆ«æ˜¯å–æ¶ˆ æˆ–è€… å¿½ç•¥ è¿‡æœŸè¯·æ±‚ï¼Œå®é™…ä¸šåŠ¡å½“ä¸­å¯ä»¥æ ¹æ®å…·ä½“ä½¿ç”¨çš„è¯·æ±‚åº“æ¥å…·ä½“å®æ“ã€‚



## å†™åœ¨æœ€å

å› æœ¬äººæ‰ç–å­¦æµ…ï¼Œéš¾å…æœ‰é”™æ¼ï¼Œæ¬¢è¿å¤§å®¶åœ¨è¯„è®ºåŒºæŒ‡æ­£ï½

å¦‚æœä½ è§‰å¾—æœ¬æ–‡å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œä¸å¦¨ç»™æˆ‘ä¸€ä¸ªç‚¹èµå’Œæ”¶è—ï¼Œè¿™å°†æ˜¯å¯¹æˆ‘æœ€å¤§çš„é¼“åŠ±